---
// src/components/TrailSchema.astro
const { mountain, stateName } = Astro.props;

// Normalize state slug for URLs
let stateSlug = mountain.state_slug || 'new-hampshire';
if (stateSlug === 'nh') stateSlug = 'new-hampshire';
if (stateSlug === 'me') stateSlug = 'maine';
if (stateSlug === 'vt') stateSlug = 'vermont';
if (stateSlug === 'ny') stateSlug = 'new-york';
if (stateSlug === 'ca' || stateSlug === 'CA') stateSlug = 'california';

// Format distance and gain for Schema
const primaryTrail = mountain.trails?.[0];
const distance = primaryTrail?.stats?.distance || 0;
const elevationGain = primaryTrail?.stats?.gain || 0;
const estimatedTime = primaryTrail?.stats?.time || 0;
const difficulty = primaryTrail?.difficulty || primaryTrail?.stats?.difficulty || 'Moderate';

// Check if we have user reviews for aggregateRating
const userReviews = mountain.user_reviews;
const hasReviews = userReviews?.enabled && userReviews?.count > 0;

const schema = {
  "@context": "https://schema.org",
  "@type": ["TouristTrip", "TouristAttraction"],
  "name": `${mountain.name} Hiking Trail`,
  "description": mountain.generated_description?.replace(/<[^>]*>?/gm, '') || `Hiking guide for ${mountain.name} in ${stateName}.`,
  "touristType": "Hiking",
  "url": `https://summitseeker.io/${mountain.state_slug || 'new-hampshire'}/hikes/${mountain.slug}`,
  "image": mountain.mountain_hero || 'https://summitseeker.io/images/default-mountain.jpg',
  "geo": {
    "@type": "GeoCoordinates",
    "latitude": mountain.lat,
    "longitude": mountain.lon,
    "elevation": {
      "@type": "QuantitativeValue",
      "value": mountain.elevation,
      "unitCode": "FOT"
    }
  },
  "address": {
    "@type": "PostalAddress",
    "addressRegion": mountain.state || 'NH',
    "addressCountry": "US"
  },
  ...(hasReviews && {
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": userReviews.average_rating,
      "reviewCount": userReviews.count,
      "bestRating": 5,
      "worstRating": 1
    }
  }),
  "itinerary": {
    "@type": "ItemList",
    "numberOfItems": 1,
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@type": "TouristAttraction",
          "name": mountain.name,
          "description": `The summit of ${mountain.name}, standing at ${mountain.elevation} feet.`,
          "geo": {
            "@type": "GeoCoordinates",
            "latitude": mountain.lat,
            "longitude": mountain.lon
          }
        }
      }
    ]
  },
  "distance": {
    "@type": "QuantitativeValue",
    "value": distance,
    "unitCode": "SMI"
  },
  "elevationGain": {
    "@type": "QuantitativeValue",
    "value": elevationGain,
    "unitCode": "FOT"
  },
  "duration": estimatedTime ? `PT${Math.floor(estimatedTime)}H${Math.round((estimatedTime % 1) * 60)}M` : undefined,
  "activityDuration": estimatedTime ? `PT${Math.floor(estimatedTime)}H${Math.round((estimatedTime % 1) * 60)}M` : undefined,
  "keywords": [
    mountain.name,
    "hiking",
    "trail",
    stateName || mountain.state,
    difficulty,
    ...(mountain.tags || [])
  ].filter(Boolean).join(', ')
};

// Additional HowTo Schema for hiking the trail
const howToSchema = {
  "@context": "https://schema.org",
  "@type": "HowTo",
  "name": `How to Hike ${mountain.name}`,
  "description": `Step-by-step guide to hiking ${mountain.name} (${mountain.elevation} ft) in ${stateName || mountain.state}.`,
  "image": mountain.mountain_hero,
  "estimatedCost": {
    "@type": "MonetaryAmount",
    "currency": "USD",
    "value": "0-10"
  },
  "totalTime": estimatedTime ? `PT${Math.floor(estimatedTime)}H${Math.round((estimatedTime % 1) * 60)}M` : "PT4H",
  "supply": [
    {
      "@type": "HowToSupply",
      "name": "Hiking boots"
    },
    {
      "@type": "HowToSupply",
      "name": "Water and snacks"
    },
    {
      "@type": "HowToSupply",
      "name": "Map and compass or GPS"
    },
    {
      "@type": "HowToSupply",
      "name": "First aid kit"
    }
  ],
  "step": [
    {
      "@type": "HowToStep",
      "name": "Prepare and check weather",
      "text": "Check weather conditions and trail status before heading out. Pack appropriate gear.",
      "position": 1
    },
    {
      "@type": "HowToStep",
      "name": "Arrive at trailhead",
      "text": `Navigate to the trailhead. ${primaryTrail?.parking_info || 'Parking available.'}`,
      "position": 2
    },
    {
      "@type": "HowToStep",
      "name": "Follow the trail",
      "text": `Hike approximately ${distance} miles with ${elevationGain?.toLocaleString()} ft of elevation gain.`,
      "position": 3
    },
    {
      "@type": "HowToStep",
      "name": "Reach the summit",
      "text": `Enjoy the views at the ${mountain.elevation?.toLocaleString()} ft summit of ${mountain.name}.`,
      "position": 4
    },
    {
      "@type": "HowToStep",
      "name": "Return safely",
      "text": "Descend the same route (or loop trail) and return to the trailhead.",
      "position": 5
    }
  ]
};
---
<script type="application/ld+json" set:html={JSON.stringify(schema)} />
<script type="application/ld+json" set:html={JSON.stringify(howToSchema)} />
<script type="application/ld+json" set:html={JSON.stringify({
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://summitseeker.io" },
    { "@type": "ListItem", "position": 2, "name": mountain.state || stateSlug.replace(/-/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase()), "item": `https://summitseeker.io/${stateSlug}` },
    { "@type": "ListItem", "position": 3, "name": mountain.name, "item": `https://summitseeker.io/${stateSlug}/hikes/${mountain.slug}` }
  ]
})} />
