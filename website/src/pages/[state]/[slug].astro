---
import Layout from '../../layouts/Layout.astro';
import TrailDashboard from '../../components/TrailDashboard';
import SiteFooter from '../../components/SiteFooter.astro';
import TrailSchema from '../../components/TrailSchema.astro';
// FIX 1: Added .jsx extension explicitly to prevent editor import errors
import { SmartTrailAlert } from '../../components/SmartTrailAlert.jsx';

export async function getStaticPaths() {
  const allFiles = await Astro.glob('../../data/*/*.json');
  return allFiles.map(file => {
      const data = file.default;
      return {
          params: { state: data.state_slug, slug: data.slug },
          props: { mountain: data }
      };
  });
}

const { mountain } = Astro.props;
const { state } = Astro.params;

// Helper: Format 'new-hampshire' -> 'New Hampshire'
const stateName = state
    ? state.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
    : 'Back';

// Fallback logic for Hero Image
const bgImage = mountain.mountain_hero || mountain.image || `https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?auto=format&fit=crop&q=80&w=2000`;
---

<Layout title={mountain.name} description={mountain.generated_description}>
  <slot name="head">
    <TrailSchema mountain={mountain} stateName={stateName} />
  </slot>

  {/* --- HERO SECTION --- */}
  <div class="relative h-[550px] flex items-end pb-16 group overflow-hidden">

    {/* Dynamic Background Image */}
    <div class="absolute inset-0">
        <img
            src={bgImage}
            class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-[2s]"
            alt={mountain.name}
            transition:name={`img-${mountain.slug}`}
        />
        {/* Gradients for readability */}
        <div class="absolute inset-0 bg-gradient-to-b from-stone-900/60 via-transparent to-stone-900/90"></div>
    </div>

    {/* --- BREADCRUMB NAVIGATION --- */}
    <div class="absolute top-0 left-0 w-full p-6 z-20">
        <nav class="max-w-7xl mx-auto flex items-center gap-2 text-xs font-bold text-white/80 uppercase tracking-widest drop-shadow-md">
            <a href="/" class="hover:text-emerald-400 transition-colors flex items-center gap-1">Home</a>
            <span class="opacity-30">/</span>
            <a href={`/${state}`} class="hover:text-emerald-400 transition-colors">{stateName}</a>
            <span class="opacity-30">/</span>
            <span class="text-emerald-400">{mountain.name}</span>
        </nav>
    </div>

    {/* HERO CONTENT */}
    <div class="relative z-10 max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col md:flex-row justify-between items-end gap-6">
            <div>
                <span class="inline-flex items-center gap-2 py-1 px-3 rounded-full bg-emerald-500/20 backdrop-blur-md border border-emerald-400/30 text-emerald-100 text-[10px] font-bold uppercase tracking-widest mb-6">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                    Live Conditions
                </span>

                <h1 class="font-serif text-5xl md:text-7xl font-black text-white mb-4 shadow-sm tracking-tight">
                    {mountain.name}
                </h1>

                {/* FIX 2: NAVIGATE BUTTON (Uses the new 'logistics' field from main.py) */}
                {mountain.trails?.[0]?.logistics?.directions_url && (
                    <a
                        href={mountain.trails[0].logistics.directions_url}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-white text-stone-900 text-sm font-bold rounded-lg hover:bg-stone-100 transition-colors shadow-lg mb-6"
                    >
                        <span>üöó</span> Navigate to Trailhead
                    </a>
                )}

                <div class="flex items-center gap-6 text-stone-300 font-medium">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">‚õ∞Ô∏è</span>
                        <div>
                            <div class="text-xs uppercase text-stone-500 font-bold tracking-wider">Elevation</div>
                            <div class="text-white">{mountain.elevation.toLocaleString()} ft</div>
                        </div>
                    </div>
                    <div class="w-px h-8 bg-white/10"></div>
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">üìç</span>
                        <div>
                            <div class="text-xs uppercase text-stone-500 font-bold tracking-wider">Coordinates</div>
                            <div class="text-white">{mountain.lat.toFixed(3)}, {mountain.lon.toFixed(3)}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>

  {/* --- MAIN CONTENT GRID --- */}
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">

    {/* FIX 3: SMART ALERTS (Added 'key' prop to fix editor error) */}
    {mountain.trails?.map((trail) => (
       trail.smart_logic?.ui_alert && (
         <SmartTrailAlert
           key={trail.name}
           client:idle
           smartLogic={trail.smart_logic}
         />
       )
    ))}

 {/* 2. DASHBOARD (Map, Stats, Weather) */}
    <TrailDashboard client:only="react" mountain={mountain} />

    {/* --- NEW: TRAILHEAD LOGISTICS BLOCK --- */}
    {/* This appears underneath the map dashboard */}
    {mountain.trails?.[0]?.logistics && (
        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">

            {/* Left: Directions Card */}
            <div class="bg-stone-50 p-6 rounded-2xl border border-stone-100 flex flex-col justify-between">
                <div>
                    <h3 class="text-stone-900 font-bold font-serif text-lg mb-2">Trailhead & Parking</h3>
                    <p class="text-stone-600 text-sm mb-4">
                        {mountain.trails[0].logistics.parking_info}
                    </p>
                </div>
                <a
                    href={mountain.trails[0].logistics.directions_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="flex items-center justify-center gap-2 w-full py-3 bg-white border border-stone-200 text-stone-900 font-bold rounded-xl hover:bg-stone-100 transition-colors shadow-sm text-sm"
                >
                    <span>üöó</span> Open in Google Maps
                </a>
            </div>

            {/* Right: Smart Details Grid */}
            <div class="bg-white p-6 rounded-2xl border border-stone-100 shadow-sm">
                <h3 class="text-stone-900 font-bold font-serif text-lg mb-4 flex items-center gap-2">
                    <span>üÖøÔ∏è</span> Access Details
                </h3>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {/* Capacity */}
                    <div class="p-3 bg-stone-50 rounded-lg">
                        <div class="text-[10px] uppercase text-stone-400 font-bold tracking-wider mb-1">Capacity</div>
                        <div class="font-medium text-stone-800 text-sm">
                            {mountain.trails[0].logistics.capacity || "Unknown"}
                        </div>
                    </div>

                    {/* Busy Status */}
                    <div class="p-3 bg-amber-50 rounded-lg">
                        <div class="text-[10px] uppercase text-amber-800/60 font-bold tracking-wider mb-1">Busy Times</div>
                        <div class="font-medium text-amber-900 text-sm">
                            {mountain.trails[0].logistics.status || "Standard traffic"}
                        </div>
                    </div>

                    {/* Fees */}
                    <div class="p-3 bg-stone-50 rounded-lg">
                        <div class="text-[10px] uppercase text-stone-400 font-bold tracking-wider mb-1">Fees / Permits</div>
                        <div class="font-medium text-stone-800 text-sm">
                            {mountain.trails[0].logistics.fee || "Free"}
                        </div>
                    </div>

                    {/* Shuttle/Notes */}
                    {mountain.trails[0].logistics.shuttle && (
                         <div class="p-3 bg-blue-50 rounded-lg">
                            <div class="text-[10px] uppercase text-blue-800/60 font-bold tracking-wider mb-1">Shuttle Info</div>
                            <div class="font-medium text-blue-900 text-sm">
                                {mountain.trails[0].logistics.shuttle}
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </div>
    )}

  </div>

  <SiteFooter />

</Layout>