---
/**
 * Mountain Detail Page
 * Location: src/pages/[state]/hikes/[slug].astro
 *
 * FIXED: Import paths updated for /hikes/ subdirectory (3 levels deep)
 * FIXED: Now handles both 'trails' and 'trails_config' data structures
 */

// Layout - now 3 levels up
import Layout from '../../../layouts/Layout.astro';

// Phase 1-3 Components
import SEOHead from '../../../components/SEOHead.astro';
import FAQSection from '../../../components/FAQSection.astro';
import SeasonalGuide from '../../../components/SeasonalGuide.astro';
import SafetySection from '../../../components/SafetySection.astro';
import DownloadsSection from '../../../components/DownloadsSection.astro';

// Existing Components
import TrailSchema from '../../../components/TrailSchema.astro';
import SocialPulse from '../../../components/SocialPulse.astro';
import NearbyPeaksAstro from '../../../components/NearbyPeaks.astro';
import Footer from '../../../components/Footer.astro';

// React Components
import TrailDashboard from '../../../components/TrailDashboard.jsx';
import WeatherWidget from '../../../components/WeatherWidget.jsx';

// REQUIRED: getStaticPaths for dynamic routes
export async function getStaticPaths() {
  // Data is now 3 levels up
  const modules = import.meta.glob('../../../data/*/*.json', { eager: true });

  return Object.entries(modules)
    .map(([path, data]) => data.default || data)
    .filter(mountain => mountain && mountain.slug && mountain.name) // Filter out blog posts
    .map(mountain => {
      // Normalize state_slug
      let stateSlug = mountain.state_slug || 'new-hampshire';
      if (stateSlug === 'nh') stateSlug = 'new-hampshire';
      if (stateSlug === 'me') stateSlug = 'maine';
      if (stateSlug === 'vt') stateSlug = 'vermont';
      if (stateSlug === 'ny') stateSlug = 'new-york';

      return {
        params: {
          state: stateSlug,
          slug: mountain.slug
        },
        props: { mountain: { ...mountain, state_slug: stateSlug } }
      };
    });
}

const { mountain } = Astro.props;

// Extract page content
const pageContent = mountain.page_content || {};
const engagement = mountain.engagement || {};
const seo = mountain.seo || {};

// FIXED: Check both data structures for trails
const trails = mountain.trails || mountain.trails_config || [];
const hasTrails = trails.length > 0;
const trailCount = trails.length;

// Get first trail's difficulty
const firstTrailDifficulty = trails[0]?.difficulty || trails[0]?.stats?.difficulty || null;
---

<Layout title={seo.meta_title || `${mountain.name} Trail Guide`}>
  <SEOHead slot="head" mountain={mountain} />
  <TrailSchema slot="head" mountain={mountain} />

  <main class="min-h-screen bg-stone-50">
    <!-- Hero Section -->
    <section class="hero relative h-[70vh] min-h-[500px] overflow-hidden">
      <div class="absolute inset-0">
        <img
          src={mountain.mountain_hero || '/images/default-hero.jpg'}
          alt={`${mountain.name} summit view`}
          class="w-full h-full object-cover"
          loading="eager"
        />
        <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent"></div>
      </div>

      <div class="relative h-full flex flex-col justify-end pb-12 px-4 md:px-8 max-w-7xl mx-auto">
        <!-- Breadcrumb -->
        <nav class="mb-4" aria-label="Breadcrumb">
          <ol class="flex items-center gap-2 text-sm text-white/70">
            <li><a href="/" class="hover:text-white">Home</a></li>
            <li>/</li>
            <li><a href={`/${mountain.state_slug}`} class="hover:text-white capitalize">{mountain.state || mountain.state_slug?.replace('-', ' ')}</a></li>
            <li>/</li>
            <li class="text-white font-medium">{mountain.name}</li>
          </ol>
        </nav>

        <!-- H1 Title -->
        <h1 class="text-4xl md:text-6xl font-bold text-white mb-4">
          {mountain.name}
        </h1>

        <p class="text-xl text-white/90 mb-6">
          {mountain.elevation?.toLocaleString()} ft | {trailCount} trails | {mountain.state || mountain.state_slug?.replace('-', ' ')}
        </p>

        <!-- Quick Stats -->
        <div class="flex flex-wrap gap-4">
          <div class="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-2">
            <span class="text-white/70 text-sm">Elevation</span>
            <p class="text-white font-bold">{mountain.elevation?.toLocaleString()} ft</p>
          </div>

          <div class="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-2">
            <span class="text-white/70 text-sm">Trails</span>
            <p class="text-white font-bold">{trailCount} routes</p>
          </div>

          {firstTrailDifficulty && (
            <div class="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-2">
              <span class="text-white/70 text-sm">Difficulty</span>
              <p class="text-white font-bold">{firstTrailDifficulty}</p>
            </div>
          )}

          {mountain.tags?.includes('4000 Footer') && (
            <div class="bg-emerald-500/90 backdrop-blur-sm rounded-lg px-4 py-2">
              <span class="text-white/90 text-sm">Peak List</span>
              <p class="text-white font-bold">NH 4000-Footer</p>
            </div>
          )}
        </div>
      </div>
    </section>

    <!-- Main Content Area -->
    <div class="max-w-7xl mx-auto px-4 md:px-8 py-8">

      <!-- Trail Dashboard - Shows when trail data exists (either trails or trails_config) -->
      {hasTrails && (
        <section class="mt-8 relative z-10 mb-12" id="trails">
          <TrailDashboard
            client:only="react"
            mountain={mountain}
          />
        </section>
      )}

      <!-- Fallback when no trail data at all -->
      {!hasTrails && (
        <section class="-mt-24 relative z-10 mb-12 bg-white rounded-2xl shadow-xl p-8">
          <div class="text-center py-8">
            <svg class="w-16 h-16 mx-auto text-stone-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
            </svg>
            <h2 class="text-2xl font-bold text-stone-900 mb-2">Trail Maps Coming Soon</h2>
            <p class="text-stone-600 max-w-md mx-auto">
              We're working on detailed trail maps for {mountain.name}.
              Check back soon for interactive routes and elevation profiles.
            </p>
          </div>

          <!-- Basic Info Grid -->
          <div class="mt-8 grid md:grid-cols-2 gap-6">
            <div class="bg-stone-50 rounded-xl p-6">
              <h3 class="font-bold text-stone-900 mb-4">Summit Information</h3>
              <dl class="space-y-3">
                <div class="flex justify-between">
                  <dt class="text-stone-500">Elevation</dt>
                  <dd class="font-bold">{mountain.elevation?.toLocaleString()} ft</dd>
                </div>
                <div class="flex justify-between">
                  <dt class="text-stone-500">Coordinates</dt>
                  <dd class="font-mono text-sm">{mountain.lat?.toFixed(4)}, {mountain.lon?.toFixed(4)}</dd>
                </div>
                <div class="flex justify-between">
                  <dt class="text-stone-500">State</dt>
                  <dd class="font-bold capitalize">{mountain.state || mountain.state_slug?.replace('-', ' ')}</dd>
                </div>
              </dl>
            </div>

            <!-- Weather Widget -->
            <div>
              <WeatherWidget
                client:only="react"
                lat={mountain.lat}
                lon={mountain.lon}
                elevation={mountain.elevation}
              />
            </div>
          </div>
        </section>
      )}

      <!-- Additional Content -->
      <div class="space-y-8 mt-8">

        <!-- Description -->
        {mountain.generated_description && (
          <section class="bg-white rounded-xl p-6 border border-stone-200" id="about">
            <h2 class="text-2xl font-bold text-stone-900 mb-4">About {mountain.name}</h2>
            <div class="prose prose-stone max-w-none" set:html={mountain.generated_description} />
          </section>
        )}

        <!-- User Reviews - Using fixed component -->
        <SocialPulse
          userReviews={mountain.user_reviews}
          mountainName={mountain.name}
        />

        <!-- FAQ Section -->
        <FAQSection faqs={pageContent.faqs} mountainName={mountain.name} />

        <!-- Seasonal Guide -->
        <SeasonalGuide seasons={pageContent.seasonal_guide} elevation={mountain.elevation} />

        <!-- Safety Section -->
        <SafetySection safety={pageContent.safety} mountainName={mountain.name} elevation={mountain.elevation} />

        <!-- Downloads -->
        <div class="bg-white rounded-xl border border-stone-200 p-6">
          <DownloadsSection mountain={mountain} downloads={engagement.downloads} />
        </div>
      </div>

      <!-- Nearby Peaks -->
      {mountain.nearby_peaks && mountain.nearby_peaks.length > 0 && (
        <NearbyPeaksAstro
          peaks={mountain.nearby_peaks}
          currentMountain={mountain.name}
          stateSlug={mountain.state_slug}
        />
      )}
    </div>

    <!-- Footer -->
    <Footer />
  </main>
</Layout>