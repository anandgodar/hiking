---
/**
 * State Index Page
 * Location: src/pages/[state]/index.astro
 *
 * FIXED: All URLs now include /hikes/ path segment
 * FIXED: Uses import.meta.glob instead of deprecated Astro.glob
 */
import Layout from '../../layouts/Layout.astro';
import SiteFooter from '../../components/SiteFooter.astro';
import MountainCard from '../../components/MountainCard.astro';
import GlobalSearch from '../../components/GlobalSearch.astro';

export async function getStaticPaths() {
  const allFiles = import.meta.glob('../../data/*/*.json', { eager: true });
  const allMountains = Object.values(allFiles).map(f => f.default || f);

  // Normalize slugs
  const normalizeState = (s) => {
    if (s === 'nh') return 'new-hampshire';
    if (s === 'me') return 'maine';
    if (s === 'vt') return 'vermont';
    if (s === 'ny') return 'new-york';
    return s;
  };

  const states = [...new Set(allMountains.map(m => normalizeState(m.state_slug)))];

  return states.map(stateSlug => {
    const stateMountains = allMountains
      .filter(m => normalizeState(m.state_slug) === stateSlug)
      .sort((a, b) => b.elevation - a.elevation);

    return {
      params: { state: stateSlug },
      props: { mountains: stateMountains, stateSlug }
    };
  });
}

const { mountains, stateSlug } = Astro.props;

// Search Index - FIXED: Added /hikes/ to URL
const allFiles = import.meta.glob('../../data/*/*.json', { eager: true });
const allMountains = Object.values(allFiles).map(f => f.default || f);
const searchIndex = allMountains.map(m => {
  const sUrl = m.state_slug === 'nh' ? 'new-hampshire' : m.state_slug;
  return {
    title: m.name,
    type: 'Mountain',
    subtitle: m.state || m.state_slug,
    url: `/${sUrl}/hikes/${m.slug}`,
    image: m.mountain_hero || m.image,
    tags: m.tags || []
  };
});

// State Configuration
const stateConfig = {
  'new-hampshire': {
    name: "New Hampshire",
    heroImage: "https://images.unsplash.com/photo-1589656966895-2f33e7653819?auto=format&fit=crop&q=80&w=2000",
    featuredCollections: [
      { id: 'best-hike', title: "Best Hikes", icon: "star", desc: "Top-rated trails." },
      { id: '4000-footer', title: "4000 Footers", icon: "mountain", desc: "The legendary 48 high peaks." },
      { id: '52-with-a-view', title: "52 With a View", icon: "eye", desc: "Stunning vistas under 4k." },
      { id: 'waterfall', title: "Waterfalls", icon: "water", desc: "Chasing cascades." },
    ]
  },
  'maine': {
    name: "Maine",
    heroImage: "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?auto=format&fit=crop&q=80&w=2000",
    featuredCollections: [
      { id: 'best-hike', title: "Best Hikes", icon: "star", desc: "The absolute best of Vacationland." },
      { id: '4000-footer', title: "4000 Footers", icon: "mountain", desc: "Maine's rugged giants." },
      { id: 'waterfall', title: "Waterfalls", icon: "water", desc: "Scenic cascades." },
    ]
  },
  'vermont': {
    name: "Vermont",
    heroImage: "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?auto=format&fit=crop&q=80&w=2000",
    featuredCollections: [
      { id: '4000-footer', title: "The VT 5", icon: "mountain", desc: "Vermont's highest peaks." },
      { id: 'long-trail', title: "Long Trail", icon: "trail", desc: "Historic thru-hike sections." },
      { id: 'fire-tower', title: "Fire Towers", icon: "tower", desc: "360-degree lookouts." }
    ]
  },
  'new-york': {
    name: "New York",
    heroImage: "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?auto=format&fit=crop&q=80&w=2000",
    featuredCollections: [
      { id: 'high-peak', title: "High Peaks", icon: "mountain", desc: "The legendary 46 peaks." },
      { id: 'catskill', title: "Catskills", icon: "tree", desc: "Rugged southern peaks." },
      { id: 'waterfall', title: "Waterfalls", icon: "water", desc: "Scenic cascades." }
    ]
  },
  'default': {
    name: stateSlug ? stateSlug.replace(/-/g, ' ') : 'Wilderness',
    heroImage: "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b",
    featuredCollections: []
  }
};

const config = stateConfig[stateSlug] || stateConfig['default'];

// Utils
const slugify = (text) => text.toString().toLowerCase().trim()
  .replace(/_/g, '-')
  .replace(/\s+/g, '-')
  .replace(/s$/, '')
  .replace(/[^\w\-]+/g, '');

const formatTag = (tag) => {
  if (tag === 'best' || tag === 'best-hike') return 'Best Hikes';
  return tag.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
};

// Build tag counts
const tagCounts = {};
mountains.forEach(m => {
  const allTags = [
    ...(m.tags || []),
    ...(m.features?.map(f => f.type) || []),
    ...(m.trails?.flatMap(t => t.tags) || []),
    m.trails?.[0]?.stats?.difficulty
  ].filter(Boolean);

  allTags.forEach(t => {
    const key = slugify(t);
    tagCounts[key] = (tagCounts[key] || 0) + 1;
  });
});

const pinnedTags = ['best-hike', '4000-footer', 'waterfall', 'dog-friendly'];
const allCategories = Object.entries(tagCounts).sort((a, b) => {
  const aPinned = pinnedTags.includes(a[0]);
  const bPinned = pinnedTags.includes(b[0]);
  if (aPinned && !bPinned) return -1;
  if (!aPinned && bPinned) return 1;
  return b[1] - a[1];
});

const getCollectionItems = (collectionId) => {
  return mountains.filter(m => {
    const mTags = [
      ...(m.tags || []),
      ...(m.features?.map(f => f.type) || []),
      ...(m.trails?.flatMap(t => t.tags) || []),
      m.trails?.[0]?.stats?.difficulty
    ].filter(Boolean).map(t => slugify(t));
    return mTags.includes(collectionId);
  }).slice(0, 4);
};

// Icon helper function
const getIconSvg = (iconName) => {
  const icons = {
    star: '<path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>',
    mountain: '<path d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22L14 6z"/>',
    water: '<path d="M12 2c-5.33 4.55-8 8.48-8 11.8 0 4.98 3.8 8.2 8 8.2s8-3.22 8-8.2c0-3.32-2.67-7.25-8-11.8z"/>',
    eye: '<path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>',
    trail: '<path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7"/>',
    tower: '<path d="M12 2L4 5v6.09c0 5.05 3.41 9.76 8 10.91 4.59-1.15 8-5.86 8-10.91V5l-8-3zm6 9.09c0 4-2.55 7.7-6 8.83-3.45-1.13-6-4.82-6-8.83V6.31l6-2.25 6 2.25v4.78z"/>',
    tree: '<path d="M17 12h2L12 2 5 12h2l-3 8h6v4h4v-4h6l-3-8z"/>',
    compass: '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-2.5l7.51-3.49L17.5 6.5 9.99 9.99 6.5 17.5zm5.5-6.6c.61 0 1.1.49 1.1 1.1s-.49 1.1-1.1 1.1-1.1-.49-1.1-1.1.49-1.1 1.1-1.1z"/>'
  };
  return icons[iconName] || icons.mountain;
};
---

<Layout
  title={`Best Hiking Trails in ${config.name} 2026 | ${mountains.length} Trail Guides & Maps`}
  description={`Discover the top ${mountains.length} hiking trails in ${config.name}. Detailed trail guides, topographic maps, elevation profiles, weather forecasts & parking info for every hike. From beginner to expert.`}
>

  <!-- HERO SECTION -->
  <div class="relative h-[65vh] flex items-center justify-center overflow-hidden group">
    <div class="absolute inset-0">
      <img
        src={config.heroImage}
        class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-[3s]"
        alt={`${config.name} Wilderness`}
      />
      <div class="absolute inset-0 bg-stone-900/50 mix-blend-multiply"></div>
      <div class="absolute inset-0 bg-gradient-to-t from-stone-900/90 via-transparent to-transparent"></div>
    </div>

    <!-- BREADCRUMB -->
    <div class="absolute top-0 left-0 w-full p-6 z-20">
      <nav class="max-w-7xl mx-auto flex items-center gap-3 text-sm font-bold text-white/90 uppercase tracking-widest drop-shadow-md">
        <a href="/" class="hover:text-emerald-400 transition-colors">Home</a>
        <span class="opacity-40">/</span>
        <span class="text-emerald-400">{config.name}</span>
      </nav>
    </div>

    <div class="relative z-10 w-full max-w-4xl px-4 text-center mt-8">
      <div class="inline-block py-1.5 px-4 border border-white/20 bg-white/10 backdrop-blur-md rounded-full text-white text-[10px] font-bold uppercase tracking-widest mb-6 shadow-lg">
        {mountains.length} Hiking Trails
      </div>
      <h1 class="font-serif text-5xl md:text-7xl font-black text-white mb-4 shadow-xl tracking-tight drop-shadow-2xl leading-tight">
        Best Hikes in {config.name}
      </h1>
      <p class="text-white/90 text-lg md:text-xl max-w-2xl mx-auto mb-6">
        Complete trail guides with maps, elevation profiles, weather forecasts & parking details for every mountain
      </p>

      <!-- SEARCH BAR -->
      <div class="max-w-xl mx-auto transform transition-all hover:scale-[1.01]">
        <GlobalSearch searchIndex={searchIndex} />
      </div>

      <p class="text-white/80 text-sm font-bold mt-6 tracking-wide uppercase">
        {mountains.length} Curated Adventures
      </p>
    </div>
  </div>

  <div class="bg-stone-50 py-12 space-y-24 relative z-10">

    <!-- DISCOVERY BAR - FIXED: /hikes/ in URL -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-24 relative z-20">
      <div class="bg-white/95 backdrop-blur-xl p-8 rounded-[2rem] shadow-2xl shadow-stone-900/10 border border-stone-100">
        <h3 class="font-serif text-xl font-bold text-stone-900 mb-6 flex items-center gap-2">
          <svg class="w-6 h-6 text-emerald-600" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-2.5l7.51-3.49L17.5 6.5 9.99 9.99 6.5 17.5zm5.5-6.6c.61 0 1.1.49 1.1 1.1s-.49 1.1-1.1 1.1-1.1-.49-1.1-1.1.49-1.1 1.1-1.1z"/>
          </svg>
          Filter by Category
        </h3>

        <div class="flex flex-wrap gap-2">
          {allCategories.map(([tag, count]) => {
            const isPinned = pinnedTags.includes(tag);
            return (
              <a
                href={`/${stateSlug}/hikes/${tag}`}
                class={`group flex items-center gap-2.5 px-4 py-2 rounded-xl border text-sm font-bold transition-all duration-300
                ${isPinned 
                  ? 'bg-emerald-50 border-emerald-200 text-emerald-800 hover:bg-emerald-100 hover:scale-105 shadow-sm' 
                  : 'bg-white border-stone-200 text-stone-600 hover:bg-stone-50 hover:border-stone-300'}
                `}
              >
                <span>{formatTag(tag)}</span>
                <span class={`text-[10px] py-0.5 px-2 rounded-lg transition-colors ${isPinned ? 'bg-emerald-200 text-emerald-900' : 'bg-stone-100 text-stone-500 group-hover:bg-stone-200'}`}>
                  {count}
                </span>
              </a>
            );
          })}
        </div>
      </div>
    </div>

    <!-- SWIMLANES - FIXED: /hikes/ in URL -->
    {config.featuredCollections.map(c => {
      const items = getCollectionItems(c.id);
      if (items.length === 0) return null;

      return (
        <section id={c.id} class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 border-b border-stone-200 pb-6 gap-4">
            <div>
              <div class="flex items-center gap-3 mb-1">
                <span class="bg-emerald-100 w-12 h-12 flex items-center justify-center rounded-2xl shadow-sm">
                  <svg class="w-6 h-6 text-emerald-600" fill="currentColor" viewBox="0 0 24 24" set:html={getIconSvg(c.icon)} />
                </span>
                <h2 class="font-serif text-4xl font-bold text-stone-900">{c.title}</h2>
              </div>
              <p class="text-stone-500 font-medium ml-1 text-sm md:text-base max-w-lg mt-2">{c.desc}</p>
            </div>

            <a href={`/${stateSlug}/hikes/${c.id}`} class="group flex items-center gap-2 text-xs font-bold text-emerald-600 uppercase tracking-widest bg-emerald-50 px-4 py-2 rounded-full hover:bg-emerald-100 transition-all">
              View All {c.title}
              <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </a>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
            {items.map(m => <MountainCard mountain={m} />)}
          </div>
        </section>
      );
    })}

    <!-- MASTER LIST -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 bg-white rounded-3xl border border-stone-100 shadow-xl">
      <div class="flex items-center justify-between mb-10 border-b border-stone-100 pb-8">
        <div>
          <h2 class="font-serif text-3xl font-bold text-stone-900">Complete Index</h2>
          <p class="text-stone-500 text-sm mt-1">A-Z listing of all peaks in {config.name}</p>
        </div>
        <div class="bg-stone-100 px-4 py-2 rounded-xl">
          <span class="text-stone-600 text-xs font-bold uppercase tracking-wider">{mountains.length} Peaks</span>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {mountains.map(m => <MountainCard mountain={m} />)}
      </div>
    </section>

  </div>
  <SiteFooter />
</Layout>